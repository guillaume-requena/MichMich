<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  </head>
  <body>
    <div id="app">
      <label class="big">
        Truck
      </label>
      <form @submit.prevent="sendData">
        <label>
          Length:
        </label>
        <input type="text" name="Length" v-model="Length">
        <label>
          mm.
        </label>
        <label>
          Width:
        </label>
        <input type="text" name="Width" v-model="Width">
        {{ Length }}
        {{ Width }}
        <label>
          mm.
        </label>
        <pre>
          {{ pallets }}
        </pre>
        <label class="big">
          Pallet
        </label>
        <div v-for="(pallet,k) in pallets"
        >
          <label>
            Length
          </label>
          <input type="text" name="Length" v-model="pallet.length">
          <label>
            mm.
          </label>
          <label>
            Width
          </label>
          <input type="text" name="Width" v-model="pallet.width">
          <label>
            mm.
          </label>
          <button type="button" @click="deletePallet(k)">
            X
          </button>

        </div>
        <div>
          <button type="button" @click="addPallet">
            Add pallet
          </button>
          <button type="submit">
            Valider
          </button>
        </div>
      </form>

      <div
      v-if="data"
      class="canvas"
      >
      <img src="/static/truck_chrono.jpg" :height="truckSize.height">
        <div
        class="truck"
        :style="truckSize"
        >
          <div
            v-for="(load, k) in data.loading"
          >
            <div
              class="palletGroup"
              v-for="(group, k) in load.all_positions"
              :style="palletGroupStyle(group.position)"
            >
              <div
                class="pallet"
                v-for="(pallet, k) in palletPosition(group)"
                :style="palletStyle(pallet)"
              >
                <div id="print">
                  {{ '{{' }} load.type_of_pallet.lengthÂ {{ '}}' }} X {{ '{{' }} load.type_of_pallet.width{{ '}}' }}
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>

    <script>
      const vm = new Vue({
        el : '#app',
        data (){
          return {
            Length: null,
            Width: null,
            pallets: [],
            data:null
          }
        },
        computed:{
          truckSize(){
            if (this.data){
              const screenSize = document.body.clientWidth
              const truck = this.data.truck
              const new_height = ((screenSize-500)/truck.length)*truck.width
              console.log(new_height)
              return {width:(screenSize-500) + 'px', height: new_height + 'px'}
            }
          }
        },
        methods: {
          addPallet(){
            this.pallets.push({
              length: null,
              width: null
            })
            console.log('add here')
          },
          deletePallet(k){
            this.pallets.splice(k, 1)
          },
          palletPosition(group){
            var pallets = []
            const screenSize = document.body.clientWidth
            const truck = this.data.truck
            const height_group = (group.position[3].upper_left_corner_y - group.position[0].lower_left_corner_y)*((screenSize-500)/truck.length)
            const width_group = (group.position[2].upper_right_corner_x - group.position[3].upper_left_corner_x)*((screenSize-500)/truck.length)
            const x_group = (group.position[3].upper_left_corner_x)*((screenSize-500)/truck.length)
            const y_group = Math.abs(height_group - (group.position[3].upper_left_corner_y)*((screenSize-500)/truck.length))
            const width_pallet = width_group/group.along_width
            const height_pallet = height_group/group.along_height
            for (var a=0; a<group.along_width; a++){
              var x_pallet = a*width_pallet
              for(var b=0; b<group.along_height; b++){
                var y_pallet = b*height_pallet
                pallets.push({left:x_pallet +'px' , top:y_pallet +'px', width:width_pallet +'px', height:height_pallet +'px'})
              }
            }
            return pallets
          },
          palletStyle(pallet){
            return pallet
          },
          palletGroupStyle(position){
            const screenSize = document.body.clientWidth
            const truck = this.data.truck
            const height_group = (position[3].upper_left_corner_y - position[0].lower_left_corner_y)*((screenSize-500)/truck.length)
            const width_group = (position[2].upper_right_corner_x - position[3].upper_left_corner_x)*((screenSize-500)/truck.length)
            const x_group = (position[3].upper_left_corner_x)*((screenSize-500)/truck.length)
            const y_group = Math.abs(height_group - (position[3].upper_left_corner_y)*((screenSize-500)/truck.length))
            console.log(x_group,y_group,height_group,width_group)
            return {left:x_group +'px' , top:y_group +'px', width:width_group +'px', height:height_group +'px'}
          },
          sendData(){
            fetch('http://127.0.0.1:5000/optim-load',{
              method:'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                pallets: this.pallets.map(function(pallet){
                  return {
                    type:{
                      length:parseInt(pallet.length, 10),
                      width:parseInt(pallet.width, 10)
                    }
                  }
                }),
                truck:{
                  length: parseInt(this.Length, 10),
                  width: parseInt(this.Width, 10)
                }
              })
            })
              .then((response) => {
                response.json().then((data) => {
                  this.data=data
                  console.log('data',data)
                })
              })
          }
        }
      })
      console.log('vm' , vm)

    </script>
    <style>
    * {
        box-sizing: border-box;
      }

      .truck {
        outline: 2px solid black;
        position: relative;
      }
      .photo {
        margin-top:7%;
        margin-left:25%;
        margin-right: 25%;
        width:50%;
        height:350px;
        color: #000080;
        padding-bottom:8%;
        padding-right: 1%;
        letter-spacing: normal;
      }
      .palletGroup {
        outline: 1px solid red;
        position : absolute;
      }
      .pallet {
        outline: 1px solid blue;
        position: absolute;
        display: flex;

      }
      .canvas {
        display: flex;
      }
      .big{
        font-size: 20px;
      }
      button {
        background-color: #96BF3B; /* Green */
        border: none;
        color: white;
        padding: 6px 18px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        font-family: CenturyGothic;
      }
      #print{
        margin: auto;
        font-size: 10px
      }
      img{
        width: auto;
      }
      body{
        font-family: CenturyGothic;
      }
    </style>
  </body>
</html>
